{"version":3,"file":"resolveDeps.js","names":["comment","require","dirname","relative","readFileSync","resolveModule","resolvePaths","normalizeUrl","replaceSymbols","PERMANENT_MARK","TEMPORARY_MARK","importDeclaration","moduleDeclaration","module","exports","resolveDeps","ast","result","from","selfPath","graph","resolve","rootPath","rootTree","opts","cwd","rootDir","processor","self","mark","moduleExports","translations","walkRules","rule","exec","selector","walkDecls","decl","prop","value","dependencyPath","RegExp","$1","replace","absDependencyPath","Error","css","lazyResult","process","Object","assign","updateTranslations","root","remove","token","genericId","importNotes","parent","raws","before","nodes","length","text","childNodes","map","i","node","clone","concat","tokens","hasOwnProperty"],"sources":["../src/resolveDeps.js"],"sourcesContent":["'use strict';\n\nconst {comment} = require('postcss');\nconst {dirname, relative} = require('path');\nconst {readFileSync} = require('fs');\nconst {resolveModule} = require('./resolveModule');\nconst {resolvePaths, normalizeUrl} = require('./resolvePaths');\nconst {replaceSymbols} = require('icss-utils');\n\nconst PERMANENT_MARK = 2;\nconst TEMPORARY_MARK = 1;\n// const UNMARKED = 0;\n\nconst importDeclaration = /^:import\\((.+)\\)$/;\nconst moduleDeclaration = /^:(?:export|import\\(.+\\))$/;\n\nmodule.exports = resolveDeps;\n\n/**\n * Topological sorting is used to resolve the deps order,\n * actually depth-first search algorithm.\n *\n * @see  https://en.wikipedia.org/wiki/Topological_sorting\n */\nfunction resolveDeps(ast, result) {\n  if (result.result) ({result} = result);\n  const {\n    from: selfPath,\n    graph,\n    resolve,\n    rootPath,\n    rootTree,\n  } = result.opts;\n\n  const cwd = dirname(selfPath);\n  const rootDir = dirname(rootPath);\n  const processor = result.processor;\n  const self = graph[selfPath] = graph[selfPath] || {};\n\n  self.mark = TEMPORARY_MARK;\n\n  const moduleExports = {};\n  const translations = {};\n\n  ast.walkRules(moduleDeclaration, rule => {\n    if (importDeclaration.exec(rule.selector)) {\n      rule.walkDecls(decl => translations[decl.prop] = decl.value);\n\n      const dependencyPath = RegExp.$1.replace(/['\"]/g, '');\n      const absDependencyPath = resolveModule(dependencyPath, {cwd, resolve});\n\n      if (!absDependencyPath) throw new Error(\n        'Can\\'t resolve module path from `' +\n        cwd + '` to `' + dependencyPath + '`'\n      );\n\n      if (\n        graph[absDependencyPath] &&\n        graph[absDependencyPath].mark === TEMPORARY_MARK\n      ) throw new Error(\n        'Circular dependency was found between `' +\n        selfPath + '` and `' + absDependencyPath + '`. ' +\n        'Circular dependencies lead to the unpredictable state and considered harmful.'\n      );\n\n      if (!(\n        graph[absDependencyPath] &&\n        graph[absDependencyPath].mark === PERMANENT_MARK\n      )) {\n        const css = readFileSync(absDependencyPath, 'utf8');\n        const lazyResult = processor.process(css, Object.assign({}, result.opts, {from: absDependencyPath}));\n\n        updateTranslations(translations, lazyResult.root.exports);\n      } else {\n        updateTranslations(translations, graph[absDependencyPath].exports);\n      }\n\n      return void rule.remove();\n    }\n\n    rule.walkDecls(decl => moduleExports[decl.prop] = decl.value);\n    rule.remove();\n  });\n\n  replaceSymbols(ast, translations);\n\n  for (const token in moduleExports)\n    for (const genericId in translations)\n      moduleExports[token] = moduleExports[token]\n        .replace(genericId, translations[genericId]);\n\n  self.mark = PERMANENT_MARK;\n  self.exports = ast.exports = moduleExports;\n\n  // resolve paths\n  if (cwd !== rootDir) resolvePaths(ast, cwd, rootDir);\n\n  const importNotes = comment({\n    parent: rootTree,\n    raws: {before: rootTree.nodes.length === 0 ? '' : '\\n\\n'},\n    text: ` imported from ${normalizeUrl(relative(rootDir, selfPath))} `,\n  });\n\n  const childNodes = ast.nodes.map(i => {\n    const node = i.clone({parent: rootTree});\n\n    if (\n      typeof node.raws.before === 'undefined' ||\n      node.raws.before === ''\n    ) node.raws.before = '\\n\\n';\n\n    return node;\n  });\n\n  rootTree.nodes = rootTree.nodes.concat(importNotes, childNodes);\n}\n\nfunction updateTranslations(translations, tokens) {\n  for (const genericId in translations) {\n    const token = translations[genericId];\n\n    if (tokens.hasOwnProperty(token))\n      translations[genericId] = tokens[token];\n  }\n}\n"],"mappings":"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"}