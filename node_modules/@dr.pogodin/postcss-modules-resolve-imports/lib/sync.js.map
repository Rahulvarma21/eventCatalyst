{"version":3,"file":"sync.js","names":["postcss","require","resolveDeps","extractPlugin","postcssPlugin","Once","module","exports","resolveImportsPlugin","icssExports","resolve","resolveImports","ast","result","graph","processor","createProcessor","plugins","rootPath","source","input","file","rootTree","clone","nodes","opts","from","exportRule","rule","raws","before","between","semicolon","after","selector","Object","keys","forEach","className","append","prop","value","prepend","root","selfposition","findIndex","bySelfName","precedingPlugins","slice","concat","plugin"],"sources":["../src/sync.js"],"sourcesContent":["'use strict';\n\n/**\n * Notes about postcss plugin's api\n *\n * Containers are iterated with .walk* methods.\n * - Rule is actually a selector.\n * - AtRule usually is rule, that starts from '@'.\n * - Decl are actually css rules (keys prop, value).\n *\n * @see  http://api.postcss.org/AtRule.html#walkRules\n */\n\nconst postcss = require('postcss');\nconst resolveDeps = require('./resolveDeps');\n\nconst extractPlugin = () => ({\n  postcssPlugin: 'extract-plugin',\n  Once: resolveDeps,\n});\nextractPlugin.postcss = true;\n\nmodule.exports = resolveImportsPlugin;\nmodule.exports.postcss = true;\n\n/**\n * dangerouslyPrevailCyclicDepsWarnings\n * icssExports\n * resolve.alias\n * resolve.extensions\n * resolve.modules\n */\nfunction resolveImportsPlugin({icssExports, resolve = {}} = {}) {\n  return {\n    postcssPlugin: 'postcss-modules-resolve-imports',\n    Once: resolveImports,\n  };\n\n  function resolveImports(ast, result) {\n    if (result.result) ({result} = result);\n    const graph = {};\n    const processor = createProcessor(result.processor.plugins);\n    const rootPath = ast.source.input.file;\n    const rootTree = ast.clone({nodes: []});\n\n    resolveDeps(ast, {opts: {from: rootPath, graph, resolve, rootPath, rootTree}, processor});\n\n    if (icssExports) {\n      const exportRule = postcss.rule({\n        raws: {\n          before: '',\n          between: '\\n',\n          semicolon: true,\n          after: '\\n',\n        },\n        selector: ':export',\n      });\n\n      Object.keys(ast.exports).forEach(className =>\n        exportRule.append({\n          prop: className,\n          value: ast.exports[className],\n          raws: {before: '\\n  '},\n        }));\n\n      rootTree.prepend(exportRule);\n    }\n\n    rootTree.exports = ast.exports;\n    result.root = rootTree;\n  }\n}\n\nfunction createProcessor(plugins) {\n  const selfposition = plugins.findIndex(bySelfName);\n  const precedingPlugins = plugins.slice(0, selfposition);\n\n  return postcss(precedingPlugins.concat(extractPlugin));\n}\n\nfunction bySelfName(plugin) {\n  return plugin.postcssPlugin === 'postcss-modules-resolve-imports';\n}\n"],"mappings":"AAAA,YAAY;;AAEZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,MAAMA,OAAO,GAAGC,OAAO,CAAC,SAAS,CAAC;AAClC,MAAMC,WAAW,GAAGD,OAAO,CAAC,eAAe,CAAC;AAE5C,MAAME,aAAa,GAAGA,CAAA,MAAO;EAC3BC,aAAa,EAAE,gBAAgB;EAC/BC,IAAI,EAAEH;AACR,CAAC,CAAC;AACFC,aAAa,CAACH,OAAO,GAAG,IAAI;AAE5BM,MAAM,CAACC,OAAO,GAAGC,oBAAoB;AACrCF,MAAM,CAACC,OAAO,CAACP,OAAO,GAAG,IAAI;;AAE7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASQ,oBAAoBA,CAAC;EAACC,WAAW;EAAEC,OAAO,GAAG,CAAC;AAAC,CAAC,GAAG,CAAC,CAAC,EAAE;EAC9D,OAAO;IACLN,aAAa,EAAE,iCAAiC;IAChDC,IAAI,EAAEM;EACR,CAAC;EAED,SAASA,cAAcA,CAACC,GAAG,EAAEC,MAAM,EAAE;IACnC,IAAIA,MAAM,CAACA,MAAM,EAAE,CAAC;MAACA;IAAM,CAAC,GAAGA,MAAM;IACrC,MAAMC,KAAK,GAAG,CAAC,CAAC;IAChB,MAAMC,SAAS,GAAGC,eAAe,CAACH,MAAM,CAACE,SAAS,CAACE,OAAO,CAAC;IAC3D,MAAMC,QAAQ,GAAGN,GAAG,CAACO,MAAM,CAACC,KAAK,CAACC,IAAI;IACtC,MAAMC,QAAQ,GAAGV,GAAG,CAACW,KAAK,CAAC;MAACC,KAAK,EAAE;IAAE,CAAC,CAAC;IAEvCtB,WAAW,CAACU,GAAG,EAAE;MAACa,IAAI,EAAE;QAACC,IAAI,EAAER,QAAQ;QAAEJ,KAAK;QAAEJ,OAAO;QAAEQ,QAAQ;QAAEI;MAAQ,CAAC;MAAEP;IAAS,CAAC,CAAC;IAEzF,IAAIN,WAAW,EAAE;MACf,MAAMkB,UAAU,GAAG3B,OAAO,CAAC4B,IAAI,CAAC;QAC9BC,IAAI,EAAE;UACJC,MAAM,EAAE,EAAE;UACVC,OAAO,EAAE,IAAI;UACbC,SAAS,EAAE,IAAI;UACfC,KAAK,EAAE;QACT,CAAC;QACDC,QAAQ,EAAE;MACZ,CAAC,CAAC;MAEFC,MAAM,CAACC,IAAI,CAACxB,GAAG,CAACL,OAAO,CAAC,CAAC8B,OAAO,CAACC,SAAS,IACxCX,UAAU,CAACY,MAAM,CAAC;QAChBC,IAAI,EAAEF,SAAS;QACfG,KAAK,EAAE7B,GAAG,CAACL,OAAO,CAAC+B,SAAS,CAAC;QAC7BT,IAAI,EAAE;UAACC,MAAM,EAAE;QAAM;MACvB,CAAC,CAAC,CAAC;MAELR,QAAQ,CAACoB,OAAO,CAACf,UAAU,CAAC;IAC9B;IAEAL,QAAQ,CAACf,OAAO,GAAGK,GAAG,CAACL,OAAO;IAC9BM,MAAM,CAAC8B,IAAI,GAAGrB,QAAQ;EACxB;AACF;AAEA,SAASN,eAAeA,CAACC,OAAO,EAAE;EAChC,MAAM2B,YAAY,GAAG3B,OAAO,CAAC4B,SAAS,CAACC,UAAU,CAAC;EAClD,MAAMC,gBAAgB,GAAG9B,OAAO,CAAC+B,KAAK,CAAC,CAAC,EAAEJ,YAAY,CAAC;EAEvD,OAAO5C,OAAO,CAAC+C,gBAAgB,CAACE,MAAM,CAAC9C,aAAa,CAAC,CAAC;AACxD;AAEA,SAAS2C,UAAUA,CAACI,MAAM,EAAE;EAC1B,OAAOA,MAAM,CAAC9C,aAAa,KAAK,iCAAiC;AACnE"}